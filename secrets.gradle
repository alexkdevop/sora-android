def LOCAL_PROPERTIES_FILENAME = "local.properties"

def getFile = { dir, filename ->
    File file = new File("$dir$File.separator$filename")
    file?.exists() ? file : null
}

def getPropertyFile = { dir ->
    return getFile(dir, LOCAL_PROPERTIES_FILENAME)
}

def getLocalProperties = { dir ->
    def file = getPropertyFile(dir)
    if (!file) {
        return null
    }

    Properties properties = new Properties()
    properties.load(file.newInputStream())
    return properties
}

project.ext.localProperties = getLocalProperties(rootDir)

allprojects {
    beforeEvaluate { project ->
        def properties = getLocalProperties(project.projectDir)
        if (properties) {
            rootProject.ext.localProperties.putAll(p)
        }

        project.ext.localProperties = rootProject.ext.localProperties
    }
}

ext.readSecretInQuotes = { secretName ->
    def secret = (System.getenv(secretName) != null) ? System.getenv(secretName) : project.localProperties.get(secretName)
    return maybeWrapInQuotes(secret)
}

ext.readSecret = { secretName ->
    def secret = (System.getenv(secretName) != null) ? System.getenv(secretName) : project.localProperties.get(secretName)
    return secret
}

static def maybeWrapInQuotes(content) {
    return content.startsWith("\"") ? content : "\"" + content + "\""
}
